<!doctype html>
<meta charset="utf-8" />
<title>Frigate Hot-Reload</title>
<style>
  body { margin:0; font:14px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial; background:#f6f7fb; }
  header { padding:10px 14px; background:#0f172a; color:#fff; display:flex; align-items:center; gap:12px; }
  header h1 { font-size:16px; margin:0; }
  header .actions { margin-left:auto; display:flex; gap:8px; }
  button { padding:6px 10px; border:1px solid #cbd5e1; background:#f8fafc; border-radius:8px; cursor:pointer; }
  button.primary { background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
  button.danger { background:#dc2626; color:#fff; border-color:#dc2626; }
  button.ghost { background:#fff; }
  .layout { display:grid; grid-template-columns: 340px 1fr; height: calc(100vh - 48px); }
  .sidebar { border-right:1px solid #e2e8f0; padding:10px; overflow:auto; background:#fff; }
  .main { padding:12px; overflow:auto; }
  .card { border:1px solid #e2e8f0; border-radius:12px; padding:12px; margin-bottom:12px; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.02); }
  .row { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; align-items:end; }
  .row .span2 { grid-column: span 2; }
  .row .span3 { grid-column: span 3; }
  .row .span4 { grid-column: span 4; }
  textarea { width:100%; height:220px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; border-radius:8px; border:1px solid #e2e8f0; padding:8px; background:#0b1220; color:#cbd5e1; }
  #cfg { transition:background-color .2s ease; }
  .cam-item { display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:6px; background:#fff; }
  .cam-item.active { background:#eff6ff; border-color:#93c5fd; }
  .cam-item .left { display:flex; align-items:center; gap:8px; }
  .drag-handle { cursor:grab; user-select:none; font-size:18px; line-height:1; }
  .muted { color:#64748b; font-size:12px; }
  input[type="text"], input[type="number"] { width:100%; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px; }
  select { width:100%; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px; }
  .hint { font-size:12px; color:#8a6d3b; margin-top:6px; }
  pre { white-space:pre-wrap; background:#0b1220; color:#cbd5e1; padding:10px; border-radius:8px; }
  .inline-actions { display:flex; gap:6px; }
  .ghost { opacity: 0.4; }
  .drop-marker { height: 0; border-top: 2px solid #1d4ed8; margin: 4px 0; }
  .banner { position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px; display:flex; align-items:center; gap:10px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
  .banner .timer { font-variant-numeric: tabular-nums; }
</style>

<header>
  <h1>Frigate Hot-Reload</h1>
  <div class="actions">
    <button id="refresh">Refresh</button>
    <button id="export">Export</button>
    <button id="importBtn">Import</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
        <strong>Cameras</strong>
        <span class="muted" id="camCount">0</span>
      </div>
      <div id="camList"></div>
      <div class="row" style="margin-top:8px;">
        <div class="span2">
          <label class="muted">Source key</label>
          <input id="cloneSource" type="text" placeholder="cam1" />
        </div>
        <div class="span2">
          <label class="muted">Target key</label>
          <input id="cloneTarget" type="text" placeholder="cam2" />
        </div>
        <div class="span4" style="display:flex; gap:8px;">
          <button id="cloneFromSelected" class="ghost">Clone from selected</button>
          <button id="cloneApply" class="primary">Clone Apply</button>
        </div>
      </div>
      <div class="hint">Tip: влачи и пускай камерите, за да пренареждаш. Промените се прилагат веднага.</div>
    </div>
  </aside>

  <main class="main">
    <div class="card">
      <div style="display:flex; align-items:center; gap:8px;">
        <strong>Config JSON</strong>
        <span class="muted">(auto-load / apply)</span>
        <div class="inline-actions" style="margin-left:auto;">
          <button id="applyDry">Preview (dry)</button>
          <button id="applyCfg" class="primary">Apply</button>
          <button id="rollback" class="danger">Rollback latest</button>
        </div>
      </div>
      <textarea id="cfg"></textarea>
      <div id="preview" class="hint"></div>
    </div>
    <div class="card">
      <strong>Logs</strong>
      <pre id="log"></pre>
    </div>
  </main>
</div>

<div id="undoBanner" class="banner" style="display:none;">
  Deleted <strong id="undoKey"></strong>. Undo in <span class="timer" id="undoTimer">10</span>s
  <button id="undoBtn" class="ghost">Undo</button>
</div>

<script>
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const log = (m) => { const el = $('#log'); el.textContent += (typeof m==='string'?m:JSON.stringify(m)) + '\n'; el.scrollTop = el.scrollHeight; };

let state = { cfg: {}, selected: null };
let undo = { key: null, value: null, t: null, left: 0, timerId: null };

async function fetchJSON(url, opts={}){
  const res = await fetch(url, { credentials:'same-origin', ...opts });
  const txt = await res.text();
  try { return { ok: res.ok, status: res.status, data: JSON.parse(txt) }; }
  catch { return { ok: res.ok, status: res.status, data: txt }; }
}

function isValidKey(k){
  return /^[A-Za-z0-9_-]+$/.test(k);
}
function assertCloneInputs(){
  const src = $('#cloneSource').value.trim();
  const tgt = $('#cloneTarget').value.trim();
  if(!src || !tgt) return { ok:false, msg:'Source/Target required' };
  if(!isValidKey(src) || !isValidKey(tgt)) return { ok:false, msg:'Only letters, digits, _ and - are allowed' };
  const keys = Object.keys(state.cfg.cameras || {});
  if(!keys.includes(src)) return { ok:false, msg:`Source '${src}' not found` };
  if(keys.includes(tgt)) return { ok:true, warn:`Target '${tgt}' exists. It will be overwritten.` };
  return { ok:true };
}

function renderCamList(){
  const wrap = $('#camList');
  wrap.innerHTML = '';
  const cams = state.cfg.cameras || {};
  const keys = Object.keys(cams);
  $('#camCount').textContent = keys.length;

  keys.forEach((k) => {
    const item = document.createElement('div');
    item.className = 'cam-item' + (state.selected===k?' active':'');
    item.draggable = true;
    item.dataset.key = k;

    const left = document.createElement('div');
    left.className = 'left';
    const drag = document.createElement('span');
    drag.className = 'drag-handle';
    drag.textContent = '⋮⋮';
    const name = document.createElement('strong');
    name.textContent = k + (cams[k]?.name ? `  (${cams[k].name})` : '');
    left.appendChild(drag); left.appendChild(name);

    const actions = document.createElement('div');
    actions.className = 'inline-actions';
    const selBtn = document.createElement('button'); selBtn.textContent = 'Select';
    selBtn.onclick = () => { state.selected = k; $('#cloneSource').value = k; renderCamList(); };
    const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.className='danger';
    delBtn.onclick = () => softDelete(k);
    actions.appendChild(selBtn); actions.appendChild(delBtn);

    item.appendChild(left); item.appendChild(actions);

    // DnD handlers (with marker)
    item.addEventListener('dragstart', (e)=>{
      item.classList.add('ghost');
      e.dataTransfer.setData('text/plain', k);
    });
    item.addEventListener('dragend', ()=> item.classList.remove('ghost'));
    item.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const rect = item.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      showMarker(item, before);
    });
    item.addEventListener('dragleave', ()=> hideMarker(item));
    item.addEventListener('drop', async (e)=>{
      e.preventDefault();
      hideMarker(item);
      const src = e.dataTransfer.getData('text/plain');
      const dst = k;
      if(!src || src===dst) return;
      await reorderByDrop(src, dst, item.dataset.before === 'true');
    });

    wrap.appendChild(item);
  });
}

function showMarker(item, before){
  hideMarker(item);
  const m = document.createElement('div');
  m.className = 'drop-marker';
  item.dataset.before = before ? 'true' : 'false';
  if(before) item.parentNode.insertBefore(m, item); else item.after(m);
  item._marker = m;
}
function hideMarker(item){
  if(item && item._marker){ item._marker.remove(); item._marker = null; }
}

async function reorderByDrop(srcKey, dstKey, placeBefore){
  const order = Object.keys(state.cfg.cameras);
  const from = order.indexOf(srcKey);
  let to = order.indexOf(dstKey);
  if(from === -1 || to === -1) return;
  const [moved] = order.splice(from,1);
  if(!placeBefore) to += (from < to ? 0 : 1); // dropping after
  order.splice(to, 0, moved);
  const res = await fetchJSON('/api/cameras/reorder', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order, apply:true }) });
  log(res.data);
  await loadConfig();
}

async function loadConfig(){
  const res = await fetchJSON('/api/config');
  if(res.ok) {
    state.cfg = res.data; $('#cfg').value = JSON.stringify(state.cfg, null, 2); renderCamList();
  } else { log(res.data); }
}

async function softDelete(key){
  // буферирай изтритата камера и покажи Undo
  const cam = (state.cfg.cameras || {})[key];
  if(!cam) return;
  undo.value = JSON.parse(JSON.stringify(cam));
  undo.key = key;
  undo.left = 10;
  $('#undoKey').textContent = key;
  $('#undoTimer').textContent = undo.left;
  $('#undoBanner').style.display = 'flex';

  const res = await fetchJSON('/api/cameras/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key, apply:true }) });
  log(res.data);
  await loadConfig();

  clearInterval(undo.timerId);
  undo.timerId = setInterval(()=>{
    undo.left -= 1;
    $('#undoTimer').textContent = undo.left;
    if(undo.left <= 0){ hideUndo(); }
  }, 1000);
}

function hideUndo(){
  clearInterval(undo.timerId);
  undo.timerId = null;
  $('#undoBanner').style.display = 'none';
  undo.key = null; undo.value = null; undo.left = 0;
}

$('#undoBtn').onclick = async ()=>{
  if(!undo.key || !undo.value) return hideUndo();
  const res = await fetchJSON('/api/cameras/set', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ key: undo.key, value: undo.value, apply: true })
  });
  log(res.data);
  if(!res.ok){ alert('Undo failed: ' + (res.data?.error?.error || res.status)); }
  hideUndo();
  await loadConfig();
};

$('#applyDry').onclick = async ()=>{
  const body = JSON.stringify(JSON.parse($('#cfg').value));
  const res = await fetchJSON('/api/config/apply?dry=true', { method:'POST', headers:{'Content-Type':'application/json'}, body });
  $('#preview').textContent = res.ok ? 'Preview OK' : ('Error: ' + JSON.stringify(res.data));
  log(res.data);
};

$('#applyCfg').onclick = async ()=>{
  const body = JSON.stringify(JSON.parse($('#cfg').value));
  const res = await fetchJSON('/api/config/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body });
  log(res.data);
  await loadConfig();
};

$('#rollback').onclick = async ()=>{
  const res = await fetchJSON('/api/config/rollback', { method:'POST' });
  log(res.data);
  await loadConfig();
};

$('#refresh').onclick = loadConfig;
$('#export').onclick = () => { window.location = '/api/config/export'; };
$('#importBtn').onclick = async ()=>{
  const txt = prompt('Paste JSON config to import:');
  if(!txt) return;
  try { JSON.parse(txt); } catch(e){ return alert('Invalid JSON'); }
  const res = await fetchJSON('/api/config/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: txt });
  log(res.data);
  await loadConfig();
};

$('#cloneFromSelected').onclick = async ()=>{
  const check = assertCloneInputs();
  if(!check.ok) return alert(check.msg);
  if(check.warn && !confirm(check.warn + ' Proceed?')) return;
  const src = $('#cloneSource').value.trim();
  const tgt = $('#cloneTarget').value.trim();
  const res = await fetchJSON('/api/cameras/clone', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ source_key: src, target_key: tgt, overwrite: true, apply: true }) });
  log(res.data);
  await loadConfig();
};

$('#cloneApply').onclick = async ()=>{
  const check = assertCloneInputs();
  if(!check.ok) return alert(check.msg);
  if(check.warn && !confirm(check.warn + ' Proceed?')) return;
  const src = $('#cloneSource').value.trim();
  const tgt = $('#cloneTarget').value.trim();
  const res = await fetchJSON('/api/cameras/clone', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ source_key: src, target_key: tgt, overwrite: true, apply: true })
  });
  log(res.data);
  await loadConfig();
};

window.addEventListener('DOMContentLoaded', loadConfig);
</script>
