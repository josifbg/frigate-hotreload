<!doctype html>
<meta charset="utf-8" />
<title>Frigate Hot-Reload</title>
<style>
  body { margin:0; font:14px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial; background:#f6f7fb; }
  header { padding:10px 14px; background:#0f172a; color:#fff; display:flex; align-items:center; gap:12px; }
  header h1 { font-size:16px; margin:0; }
  header .actions { margin-left:auto; display:flex; gap:8px; }
  button { padding:6px 10px; border:1px solid #cbd5e1; background:#f8fafc; border-radius:8px; cursor:pointer; }
  button.primary { background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
  button.danger { background:#dc2626; color:#fff; border-color:#dc2626; }
  button.ghost { background:#fff; }
  .layout { display:grid; grid-template-columns: 380px 1fr; height: calc(100vh - 48px); }
  .sidebar { border-right:1px solid #e2e8f0; padding:10px; overflow:auto; background:#fff; }
  .main { padding:12px; overflow:auto; }
  .card { border:1px solid #e2e8f0; border-radius:12px; padding:12px; margin-bottom:12px; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.02); }
  .row { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; align-items:end; }
  .row .span2 { grid-column: span 2; }
  .row .span3 { grid-column: span 3; }
  .row .span4 { grid-column: span 4; }
  textarea { width:100%; height:220px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; border-radius:8px; border:1px solid #e2e8f0; padding:8px; background:#0b1220; color:#cbd5e1; }
  #cfg { transition:background-color .2s ease; }
  .cam-item { display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:6px; background:#fff; }
  .cam-item.active { background:#eff6ff; border-color:#93c5fd; }
  .cam-item .left { display:flex; align-items:center; gap:8px; }
  .drag-handle { cursor:grab; user-select:none; font-size:18px; line-height:1; }
  .muted { color:#64748b; font-size:12px; }
  input[type="text"], input[type="number"] { width:100%; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px; }
  select { width:100%; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px; }
  .hint { font-size:12px; color:#8a6d3b; margin-top:6px; }
  pre { white-space:pre-wrap; background:#0b1220; color:#cbd5e1; padding:10px; border-radius:8px; }
  .inline-actions { display:flex; gap:6px; }
  .ghost { opacity: 0.4; }
  .drop-marker { height: 0; border-top: 2px solid #1d4ed8; margin: 4px 0; }
  .banner { position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px; display:flex; align-items:center; gap:10px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
  .banner .timer { font-variant-numeric: tabular-nums; }
  details summary { cursor:pointer; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #cbd5e1; background:#fff; }
  .dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
  .dot.ok { background:#16a34a; }
  .dot.warn { background:#f59e0b; }
  .dot.err { background:#dc2626; }
</style>

<header>
  <h1>Frigate Hot-Reload</h1>
  <div class="actions">
    <span id="authPill" class="pill"><span class="dot warn"></span><span>Auth: unknown</span></span>
    <input id="apiToken" type="password" placeholder="API token (optional)" style="border-radius:8px; border:1px solid #cbd5e1; padding:6px 8px;" />
    <button id="genToken" class="ghost">Generate token</button>
    <button id="ensureAccess" class="ghost">Ensure access</button>
    <button id="copyToken" class="ghost">Copy token</button>
    <button id="disableAuth" class="ghost">Disable auth</button>
    <button id="refresh">Refresh</button>
    <button id="export">Export</button>
    <button id="importBtn">Import</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
        <strong>Cameras</strong>
        <span class="muted" id="camCount">0</span>
      </div>
      <div id="camList"></div>
      <div class="row" style="margin-top:6px;">
        <div class="span4" style="display:flex; gap:8px; align-items:center;">
          <label class="muted"><input id="selAll" type="checkbox" /> Select all</label>
          <button id="bulkDelete" class="danger">Delete selected</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="span2">
          <label class="muted">Source key</label>
          <input id="cloneSource" type="text" placeholder="cam1" />
        </div>
        <div class="span2">
          <label class="muted">Target key</label>
          <input id="cloneTarget" type="text" placeholder="cam2" />
        </div>
        <div class="span4" style="display:flex; gap:8px;">
          <button id="cloneFromSelected" class="ghost">Clone from selected</button>
          <button id="cloneApply" class="primary">Clone Apply</button>
        </div>
      </div>
      <div class="hint">Tip: влачи и пускай камерите, за да пренареждаш. Промените се прилагат веднага.</div>
    </div>

    <!-- Add Camera with Presets -->
    <div class="card">
      <strong>Add camera (presets)</strong>
      <div class="row" style="margin-top:8px;">
        <div class="span2">
          <label class="muted">New key</label>
          <input id="addKey" type="text" placeholder="cam5" />
        </div>
        <div class="span2">
          <label class="muted">Preset</label>
          <select id="presetSelect"></select>
        </div>
        <div class="span4">
          <label class="muted">Name</label>
          <input id="addName" type="text" placeholder="Front Door" />
        </div>
        <div class="span4">
          <label class="muted">RTSP / ONVIF URL</label>
          <input id="addUrl" type="text" placeholder="rtsp://user:pass@host:554/stream" />
        </div>
        <div>
          <label class="muted">Width</label>
          <input id="addW" type="number" value="1920" />
        </div>
        <div>
          <label class="muted">Height</label>
          <input id="addH" type="number" value="1080" />
        </div>
        <div>
          <label class="muted">FPS</label>
          <input id="addFps" type="number" value="15" />
        </div>
        <div>
          <label class="muted">Enabled</label>
          <select id="addEnabled"><option value="true" selected>true</option><option value="false">false</option></select>
        </div>
        <div class="span4" style="display:flex; gap:8px;">
          <button id="addApply" class="primary">Add Apply</button>
          <button id="savePreset" class="ghost">Save as preset…</button>
        </div>
      </div>
      <details style="margin-top:6px;">
        <summary>Advanced JSON (override)</summary>
        <textarea id="addJson" placeholder="{ \"ffmpeg\": { ... }, \"detection\": { ... } }"></textarea>
        <div class="hint">Ако е попълнено, това JSON ще бъде мерджнато върху избрания preset.</div>
      </details>
    </div>
  </aside>

  <main class="main">
    <div class="card">
      <div style="display:flex; align-items:center; gap:8px;">
        <strong>Config JSON</strong>
        <span class="muted">(auto-load / apply)</span>
        <div class="inline-actions" style="margin-left:auto;">
          <button id="applyDry">Preview (dry)</button>
          <button id="applyCfg" class="primary">Apply</button>
          <button id="rollback" class="danger">Rollback latest</button>
        </div>
      </div>
      <textarea id="cfg"></textarea>
      <div id="preview" class="hint"></div>
    </div>
    <div class="card">
      <strong>Logs</strong>
      <pre id="log"></pre>
    </div>
  </main>
</div>

<div id="undoBanner" class="banner" style="display:none;">
  Deleted <strong id="undoKey"></strong>. Undo in <span class="timer" id="undoTimer">10</span>s
  <button id="undoBtn" class="ghost">Undo</button>
</div>

<script>
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
function getToken(){ try { return localStorage.getItem('api_token') || ''; } catch { return ''; } }
function authHeaders(base={}){ const t = getToken(); return t ? { ...base, 'Authorization': 'Bearer ' + t } : base; }
const log = (m) => { const el = $('#log'); el.textContent += (typeof m==='string'?m:JSON.stringify(m)) + '\n'; el.scrollTop = el.scrollHeight; };

let state = { cfg: {}, selected: null, sel: {} };
let undo = { key: null, value: null, index: null, t: null, left: 0, timerId: null };

// ---- Presets ----
const BUILTIN_PRESETS = {
  generic_rtsp: {
    label: 'Generic RTSP',
    cam: {
      name: '', enabled: true,
      ffmpeg: { url: 'rtsp://user:pass@host:554/stream', hwaccel: null, width: 1920, height: 1080, fps: 15 },
      zones: [],
      detection: { score_threshold: 0.6, iou_threshold: 0.45 },
      retention: { mode: 'motion', detection_days: 5, recording_days: 2, pre_capture_sec: 3, post_capture_sec: 3 }
    }
  },
  onvif: {
    label: 'ONVIF',
    cam: {
      name: '', enabled: true,
      ffmpeg: { url: 'rtsp://user:pass@host:554/Streaming/Channels/101', hwaccel: null, width: 1920, height: 1080, fps: 15 },
      onvif: { host: 'http://host:8000', user: 'user', pass: 'pass' },
      zones: [],
      detection: { score_threshold: 0.6, iou_threshold: 0.45 },
      retention: { mode: 'motion', detection_days: 5, recording_days: 2, pre_capture_sec: 3, post_capture_sec: 3 }
    }
  },
  hikvision: {
    label: 'Hikvision',
    cam: {
      name: '', enabled: true,
      ffmpeg: { url: 'rtsp://user:pass@host:554/Streaming/Channels/101', hwaccel: null, width: 2560, height: 1440, fps: 20 },
      zones: [],
      detection: { score_threshold: 0.6, iou_threshold: 0.45 },
      retention: { mode: 'motion', detection_days: 7, recording_days: 3, pre_capture_sec: 3, post_capture_sec: 3 }
    }
  }
};

function loadCustomPresets(){
  try { return JSON.parse(localStorage.getItem('custom_presets')||'{}'); } catch { return {}; }
}
function saveCustomPresets(obj){ localStorage.setItem('custom_presets', JSON.stringify(obj)); }

function presetsSelectOptions(){
  const sel = $('#presetSelect');
  sel.innerHTML = '';
  const opts = [];
  const addOpt = (value, label) => { const o = document.createElement('option'); o.value=value; o.textContent=label; sel.appendChild(o); };
  addOpt('generic_rtsp', 'Generic RTSP');
  addOpt('onvif', 'ONVIF');
  addOpt('hikvision', 'Hikvision');
  const custom = loadCustomPresets();
  Object.keys(custom).forEach(k => addOpt('custom:'+k, `★ ${k}`));
  sel.value = 'generic_rtsp';
}

function mergeDeep(a,b){
  if(Array.isArray(a) || Array.isArray(b)) return b;
  if(typeof a==='object' && typeof b==='object' && a && b){
    const out = {...a};
    for(const k of Object.keys(b)) out[k] = mergeDeep(a[k], b[k]);
    return out;
  }
  return b===undefined ? a : b;
}

async function fetchJSON(url, opts={}){
  const headers = authHeaders(opts.headers || {});
  const res = await fetch(url, { credentials:'same-origin', ...opts, headers });
  const txt = await res.text();
  try { return { ok: res.ok, status: res.status, data: JSON.parse(txt) }; }
  catch { return { ok: res.ok, status: res.status, data: txt }; }
}

async function refreshAuthUI(){
  try{
    const pill = document.getElementById('authPill');
    const dot = pill?.querySelector('.dot');
    const text = pill?.querySelector('span:last-child');
    const st = await fetchJSON('/api/auth/status');
    if(!pill || !st.ok) return;
    if(st.data.enabled){
      if(dot){ dot.classList.remove('ok','err','warn'); dot.classList.add('ok'); }
      if(text) text.textContent = 'Auth: enabled';
      const tok = getToken();
      if(!tok){
        if(dot){ dot.classList.remove('ok','err'); dot.classList.add('warn'); }
        if(text) text.textContent = 'Auth: enabled (no token)';
      }
    } else {
      if(dot){ dot.classList.remove('ok','err','warn'); dot.classList.add('warn'); }
      if(text) text.textContent = 'Auth: disabled';
    }
  }catch(_){ /* ignore */ }
}

async function ensureAccess(){
  try{
    const st = await fetchJSON('/api/auth/status');
    if(st.ok && st.data.enabled){
      if(!getToken()){
        const gen = await fetchJSON('/api/auth/generate', { method:'POST' });
        if(gen.ok && gen.data.token){
          try { localStorage.setItem('api_token', gen.data.token); } catch {}
          const input = document.getElementById('apiToken'); if(input) input.value = gen.data.token;
          log('Token generated automatically');
        } else {
          alert('Failed to generate token');
        }
      }
    }
    await refreshAuthUI();
    const res = await fetchJSON('/api/ping');
    if(!res.ok) alert('Access check failed');
  }catch(e){ alert('Access check error'); }
}

async function copyToken(){
  const t = getToken();
  if(!t){ alert('No token in browser'); return; }
  try{ await navigator.clipboard.writeText(t); alert('Token copied'); }
  catch{ alert('Copy failed: ' + t); }
}

function isValidKey(k){ return /^[A-Za-z0-9_-]+$/.test(k); }
function assertCloneInputs(){
  const src = $('#cloneSource').value.trim();
  const tgt = $('#cloneTarget').value.trim();
  if(!src || !tgt) return { ok:false, msg:'Source/Target required' };
  if(!isValidKey(src) || !isValidKey(tgt)) return { ok:false, msg:'Only letters, digits, _ and - are allowed' };
  const keys = Object.keys(state.cfg.cameras || {});
  if(!keys.includes(src)) return { ok:false, msg:`Source '${src}' not found` };
  if(keys.includes(tgt)) return { ok:true, warn:`Target '${tgt}' exists. It will be overwritten.` };
  return { ok:true };
}

function renderCamList(){
  const wrap = $('#camList');
  wrap.innerHTML = '';
  const cams = state.cfg.cameras || {};
  const keys = Object.keys(cams);
  $('#camCount').textContent = keys.length;

  keys.forEach((k) => {
    const item = document.createElement('div');
    item.className = 'cam-item' + (state.selected===k?' active':'');
    item.draggable = true;
    item.dataset.key = k;

    const left = document.createElement('div');
    left.className = 'left';
    const sel = document.createElement('input');
    sel.type = 'checkbox';
    sel.className = 'cam-select';
    sel.checked = !!state.sel && state.sel[k];
    sel.onchange = () => { state.sel = state.sel || {}; state.sel[k] = sel.checked; };
    const drag = document.createElement('span');
    drag.className = 'drag-handle';
    drag.textContent = '⋮⋮';
    const name = document.createElement('strong');
    name.textContent = k + (cams[k]?.name ? `  (${cams[k].name})` : '');
    left.appendChild(sel);
    left.appendChild(drag);
    left.appendChild(name);

    const actions = document.createElement('div');
    actions.className = 'inline-actions';
    const selBtn = document.createElement('button'); selBtn.textContent = 'Select';
    selBtn.onclick = () => { state.selected = k; $('#cloneSource').value = k; renderCamList(); };
    const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.className='danger';
    delBtn.onclick = () => softDelete(k);
    actions.appendChild(selBtn); actions.appendChild(delBtn);

    item.appendChild(left); item.appendChild(actions);

    // DnD handlers (with marker)
    item.addEventListener('dragstart', (e)=>{
      item.classList.add('ghost');
      e.dataTransfer.setData('text/plain', k);
    });
    item.addEventListener('dragend', ()=> item.classList.remove('ghost'));
    item.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const rect = item.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      showMarker(item, before);
    });
    item.addEventListener('dragleave', ()=> hideMarker(item));
    item.addEventListener('drop', async (e)=>{
      e.preventDefault();
      hideMarker(item);
      const src = e.dataTransfer.getData('text/plain');
      const dst = k;
      if(!src || src===dst) return;
      await reorderByDrop(src, dst, item.dataset.before === 'true');
    });

    wrap.appendChild(item);
  });
}

function showMarker(item, before){
  hideMarker(item);
  const m = document.createElement('div');
  m.className = 'drop-marker';
  item.dataset.before = before ? 'true' : 'false';
  if(before) item.parentNode.insertBefore(m, item); else item.after(m);
  item._marker = m;
}
function hideMarker(item){ if(item && item._marker){ item._marker.remove(); item._marker = null; } }

async function reorderByDrop(srcKey, dstKey, placeBefore){
  const order = Object.keys(state.cfg.cameras);
  const from = order.indexOf(srcKey);
  let to = order.indexOf(dstKey);
  if(from === -1 || to === -1) return;
  const [moved] = order.splice(from,1);
  if(!placeBefore) to += (from < to ? 0 : 1); // dropping after
  order.splice(to, 0, moved);
  const res = await fetchJSON('/api/cameras/reorder', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order, apply:true }) });
  log(res.data);
  await loadConfig();
}

async function loadConfig(){
  const res = await fetchJSON('/api/config');
  if(res.ok) { state.cfg = res.data; $('#cfg').value = JSON.stringify(state.cfg, null, 2); renderCamList(); fillFromPreset(); }
  else { log(res.data); }
}

async function softDelete(key){
  // буферирай изтритата камера и покажи Undo
  const cam = (state.cfg.cameras || {})[key];
  const keys = Object.keys(state.cfg.cameras || {});
  undo.index = keys.indexOf(key);
  if(!cam) return;
  undo.value = JSON.parse(JSON.stringify(cam));
  undo.key = key;
  undo.left = 10;
  $('#undoKey').textContent = key;
  $('#undoTimer').textContent = undo.left;
  $('#undoBanner').style.display = 'flex';

  const res = await fetchJSON('/api/cameras/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key, apply:true }) });
  log(res.data);
  await loadConfig();

  clearInterval(undo.timerId);
  undo.timerId = setInterval(()=>{
    undo.left -= 1;
    $('#undoTimer').textContent = undo.left;
    if(undo.left <= 0){ hideUndo(); }
  }, 1000);
}

$('#selAll').onchange = () => {
  const on = $('#selAll').checked;
  state.sel = {};
  Object.keys(state.cfg.cameras || {}).forEach(k => state.sel[k] = on);
  renderCamList();
};

$('#bulkDelete').onclick = async () => {
  const keys = Object.keys(state.sel || {}).filter(k => state.sel[k]);
  if(!keys.length) return alert('No cameras selected');
  if(!confirm(`Delete ${keys.length} selected camera(s)?`)) return;
  const res = await fetchJSON('/api/cameras/bulk_delete', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ keys, apply: true })
  });
  log(res.data);
  state.sel = {};
  await loadConfig();
};

function hideUndo(){
  clearInterval(undo.timerId);
  undo.timerId = null;
  $('#undoBanner').style.display = 'none';
  undo.key = null; undo.value = null; undo.index = null; undo.left = 0;
}

$('#undoBtn').onclick = async ()=>{
  if(!undo.key || !undo.value) return hideUndo();
  // 1) restore the camera definition
  const setRes = await fetchJSON('/api/cameras/set', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ key: undo.key, value: undo.value, apply: true })
  });
  log(setRes.data);
  if(!setRes.ok){ alert('Undo failed: ' + (setRes.data?.error?.error || setRes.status)); hideUndo(); return; }
  // 2) restore original position (index)
  try {
    const cfgRes = await fetchJSON('/api/config');
    if(cfgRes.ok){
      const cams = cfgRes.data.cameras || {};
      let order = Object.keys(cams).filter(k => k !== undo.key);
      const idx = Math.max(0, Math.min((undo.index ?? order.length), order.length));
      order.splice(idx, 0, undo.key);
      const reRes = await fetchJSON('/api/cameras/reorder', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order, apply: true }) });
      log(reRes.data);
    }
  } catch(_) {}
  hideUndo();
  await loadConfig();
};

$('#applyDry').onclick = async ()=>{
  const body = JSON.stringify(JSON.parse($('#cfg').value));
  const res = await fetchJSON('/api/config/apply?dry=true', { method:'POST', headers:{'Content-Type':'application/json'}, body });
  $('#preview').textContent = res.ok ? 'Preview OK' : ('Error: ' + JSON.stringify(res.data));
  log(res.data);
};

$('#applyCfg').onclick = async ()=>{
  const body = JSON.stringify(JSON.parse($('#cfg').value));
  const res = await fetchJSON('/api/config/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body });
  log(res.data);
  await loadConfig();
};

$('#rollback').onclick = async ()=>{
  const res = await fetchJSON('/api/config/rollback', { method:'POST' });
  log(res.data);
  await loadConfig();
};

$('#refresh').onclick = loadConfig;
$('#export').onclick = () => { window.location = '/api/config/export'; };
$('#importBtn').onclick = async ()=>{
  const txt = prompt('Paste JSON config to import:');
  if(!txt) return;
  try { JSON.parse(txt); } catch(e){ return alert('Invalid JSON'); }
  const res = await fetchJSON('/api/config/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: txt });
  log(res.data);
  await loadConfig();
};

$('#cloneFromSelected').onclick = async ()=>{
  const check = assertCloneInputs();
  if(!check.ok) return alert(check.msg);
  if(check.warn && !confirm(check.warn + ' Proceed?')) return;
  const src = $('#cloneSource').value.trim();
  const tgt = $('#cloneTarget').value.trim();
  const res = await fetchJSON('/api/cameras/clone', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ source_key: src, target_key: tgt, overwrite: true, apply: true }) });
  log(res.data);
  await loadConfig();
};

$('#cloneApply').onclick = async ()=>{
  const check = assertCloneInputs();
  if(!check.ok) return alert(check.msg);
  if(check.warn && !confirm(check.warn + ' Proceed?')) return;
  const src = $('#cloneSource').value.trim();
  const tgt = $('#cloneTarget').value.trim();
  const res = await fetchJSON('/api/cameras/clone', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ source_key: src, target_key: tgt, overwrite: true, apply: true })
  });
  log(res.data);
  await loadConfig();
};

function fillFromPreset(){
  const key = $('#presetSelect').value;
  const name = $('#addName');
  const url = $('#addUrl');
  const w = $('#addW');
  const h = $('#addH');
  const fps = $('#addFps');
  const en = $('#addEnabled');

  const custom = loadCustomPresets();
  let base;
  if(key.startsWith('custom:')) base = custom[key.slice(7)]; else base = BUILTIN_PRESETS[key];
  if(!base) return;
  const cam = base.cam;
  name.value = cam.name || '';
  url.value = cam.ffmpeg?.url || '';
  w.value = cam.ffmpeg?.width ?? 1920;
  h.value = cam.ffmpeg?.height ?? 1080;
  fps.value = cam.ffmpeg?.fps ?? 15;
  en.value = (cam.enabled!==false) ? 'true' : 'false';
}

$('#presetSelect').onchange = fillFromPreset;

$('#savePreset').onclick = ()=>{
  const label = prompt('Preset name:');
  if(!label) return;
  const tpl = buildCameraFromForm();
  const custom = loadCustomPresets();
  custom[label] = { label, cam: tpl };
  saveCustomPresets(custom);
  presetsSelectOptions();
  $('#presetSelect').value = 'custom:'+label;
};

function buildCameraFromForm(){
  const cam = JSON.parse(JSON.stringify((BUILTIN_PRESETS[$('#presetSelect').value]?.cam) || BUILTIN_PRESETS['generic_rtsp'].cam));
  cam.name = $('#addName').value.trim();
  cam.enabled = ($('#addEnabled').value === 'true');
  cam.ffmpeg = cam.ffmpeg || {};
  cam.ffmpeg.url = $('#addUrl').value.trim();
  cam.ffmpeg.width = parseInt($('#addW').value||'1920',10);
  cam.ffmpeg.height = parseInt($('#addH').value||'1080',10);
  cam.ffmpeg.fps = parseInt($('#addFps').value||'15',10);

  // Advanced JSON override
  const txt = $('#addJson').value.trim();
  if(txt){
    try{ const over = JSON.parse(txt); return mergeDeep(cam, over); }
    catch(e){ alert('Invalid JSON in Advanced override'); }
  }
  return cam;
}

$('#addApply').onclick = async ()=>{
  const key = $('#addKey').value.trim();
  if(!key) return alert('Key is required');
  if(!isValidKey(key)) return alert('Only letters, digits, _ and - are allowed');
  const keys = Object.keys(state.cfg.cameras || {});
  if(keys.includes(key) && !confirm(`Key '${key}' exists. Overwrite?`)) return;
  const cam = buildCameraFromForm();
  if(!cam?.ffmpeg?.url) return alert('URL is required');

  const res = await fetchJSON('/api/cameras/set', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ key, value: cam, apply: true })
  });
  log(res.data);
  await loadConfig();
};

</script>

<script>
// --- Auth helpers ---
async function ensureToken(){
  try{
    const status = await fetchJSON('/api/auth/status');
    const disabledFlag = (localStorage.getItem('auth_disabled') === '1');
    if(status.ok && !status.data.enabled && !disabledFlag){
      const gen = await fetchJSON('/api/auth/generate', { method:'POST' });
      if(gen.ok && gen.data.token){
        try { localStorage.setItem('api_token', gen.data.token); } catch {}
        const input = $('#apiToken'); if(input) input.value = gen.data.token;
        log('Token generated automatically');
      }
    }
  }catch(e){ /* ignore */ }
}

async function generateToken(){
  const gen = await fetchJSON('/api/auth/generate', { method:'POST' });
  if(gen.ok && gen.data.token){
    try { localStorage.setItem('api_token', gen.data.token); localStorage.removeItem('auth_disabled'); } catch {}
    const input = $('#apiToken'); if(input) input.value = gen.data.token;
    alert('New token generated and saved.');
  }else{
    alert('Failed to generate token: ' + JSON.stringify(gen.data));
  }
}

async function disableAuth(){
  const ok = confirm('Disable authentication? This opens all API endpoints.');
  if(!ok) return;
  const res = await fetchJSON('/api/auth/disable', { method:'POST' });
  if(res.ok){
    try { localStorage.removeItem('api_token'); localStorage.setItem('auth_disabled','1'); } catch {}
    const input = $('#apiToken'); if(input) input.value = '';
    alert('Authentication disabled.');
  } else {
    alert('Failed to disable: ' + JSON.stringify(res.data));
  }
}

try { const t = localStorage.getItem('api_token'); if(t) $('#apiToken').value = t; } catch {}
$('#apiToken').addEventListener('change', ()=>{ try { localStorage.setItem('api_token', $('#apiToken').value); } catch {} });

$('#genToken').onclick = generateToken;
$('#disableAuth').onclick = disableAuth;
$('#ensureAccess').onclick = ensureAccess;
$('#copyToken').onclick = copyToken;

window.addEventListener('DOMContentLoaded', ()=>{
  ensureToken();
  refreshAuthUI();
  presetsSelectOptions();
  fillFromPreset();
  loadConfig();
});
</script>
</script>
